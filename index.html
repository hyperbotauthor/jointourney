<style>
  td {
    text-align: center;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

<div id="app">
  <table border="1" cellpadding="5">
    <tr>
      <td>name</td>
      <td>minutes</td>
      <td>initial</td>
      <td>increment</td>
      <td>starts in min(s)</td>
      <td>player(s)</td>
      <td>open</td>
    </tr>
    <tr v-for="t in tourneys">
      <td>{{ t.fullName }}</td>
      <td>{{ t.minutes }}</td>
      <td>{{ t.clock.limit/60 }}</td>
      <td>{{ t.clock.increment }}</td>
      <td>{{ Math.floor((t.startsAt - new Date().getTime())/60000) }}</td>
      <td>{{ t.nbPlayers }}</td>
      <td>
        <a
          rel="noopener noreferrer"
          target="_blank"
          :href="`https://lichess.org/tournament/${t.id}`"
          >{{ t.id }}</a
        >
      </td>
    </tr>
  </table>
  <pre></pre>
</div>

<script>
  const API_BASE_URL = "https://lichess.org/api";

  function api(endpoint, opts) {
    return new Promise((resolve) => {
      fetch(`${API_BASE_URL}/${endpoint}`, opts || {})
        .then((resp) => {
          resp
            .json()
            .then((json) => resolve(json))
            .catch((err) => {
              console.error("could not parse response json", err);
              resp
                .text()
                .then((text) => {
                  resolve(text);
                })
                .catch((err) => {
                  console.error("could not resolve response text", err);
                  resolve(undefined);
                });
            });
        })
        .catch((err) => {
          console.error(err);
          resolve(undefined);
        });
    });
  }

  function getTourneys() {
    return new Promise((resolve) => {
      api("tournament").then((tourneys) => {
        resolve(tourneys);
      });
    });
  }

  async function init() {
    const variant = "atomic";
    const tourneys = await getTourneys();
    const created = tourneys.created.filter((t) => t.variant.key === variant);
    const started = tourneys.started.filter((t) => t.variant.key === variant);

    let effTourneys = started.concat(created);

    var app = new Vue({
      el: "#app",
      data: {
        message: JSON.stringify(effTourneys, null, 2),
        tourneys: effTourneys,
      },
    });
  }

  init();

  setTimeout(() => {
    document.location.reload();
  }, 30000);
</script>
