<style>
  table {
    border-collapse: collapse;
  }
  td {
    text-align: center;
    padding: 5px;
    border: solid 1px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

<button id="loginbutton">Login</button>
<button id="logoutbutton">Logout</button>
<span id="showusernamediv"></span>

<hr />

<script src="pkce.js"></script>
<script src="auth.js"></script>

<script>
  const variantMatch = document.location.href.match("variant=([a-zA-Z]+)");
  const variant = variantMatch ? variantMatch[1] : "standard";

  function selectVariant() {
    document.location.href = `/?variant=${
      document.getElementById("variantselect").value
    }`;
  }
</script>

<div id="app">
  <select onchange="selectVariant()" id="variantselect">
    <option
      v-for="currVariant in variants"
      :value="currVariant.key"
      :selected="currVariant.key === variant"
    >
      {{ currVariant.display }}
    </option>
  </select>
  <hr />
  <table>
    <tr>
      <td style="min-width: 300px">name</td>
      <td>minutes</td>
      <td>initial</td>
      <td>inc</td>
      <td>starts in min(s)</td>
      <td>player(s)</td>
      <td>open</td>
    </tr>
    <tr v-for="t in tourneys">
      <td
        :style="`font-size: 14px;font-family: monospace;color: ${t.secondsToStart ? '#007':'#070'}`"
      >
        {{ t.fullName }}
      </td>
      <td style="color: #707; font-weight: bold">{{ t.minutes }}</td>
      <td style="color: #700; font-weight: bold">{{ t.clock.limit/60 }}</td>
      <td>{{ t.clock.increment }}</td>
      <td style="color: #007; font-weight: bold">
        {{ Math.floor(((t.startsAt||new Date().getTime()) - new
        Date().getTime())/6000)/10 }}
      </td>

      <td style="color: #077; font-weight: bold">{{ t.nbPlayers }}</td>
      <td style="padding-left: 10px; padding-right: 10px; font-size: 10px">
        <a
          rel="noopener noreferrer"
          target="_blank"
          :href="`https://lichess.org/tournament/${t.id}`"
          >{{ t.id }}</a
        >
      </td>
    </tr>
  </table>
  <pre></pre>
</div>

<script>
  const API_BASE_URL = "https://lichess.org/api";

  function api(endpoint, opts) {
    return new Promise((resolve) => {
      fetch(`${API_BASE_URL}/${endpoint}`, opts || {})
        .then((resp) => {
          resp
            .json()
            .then((json) => resolve(json))
            .catch((err) => {
              console.error("could not parse response json", err);
              resp
                .text()
                .then((text) => {
                  resolve(text);
                })
                .catch((err) => {
                  console.error("could not resolve response text", err);
                  resolve(undefined);
                });
            });
        })
        .catch((err) => {
          console.error(err);
          resolve(undefined);
        });
    });
  }

  function getTourneys() {
    return new Promise((resolve) => {
      api("tournament").then((tourneys) => {
        resolve(tourneys);
      });
    });
  }

  async function signUp(variant) {
    const tourneys = await getTourneys();

    if (!tourneys) {
      console.error("could not get tourneys");
      return;
    }

    const created = tourneys.created.filter((t) => t.variant.key === variant);
    const started = tourneys.started.filter((t) => t.variant.key === variant);

    let effTourneys = started.concat(created);

    for (let t of effTourneys) {
      const startingIn = t.secondsToStart
        ? `starting in ${Math.floor(t.secondsToStart / 60)} min(s)`
        : `finishes in ${Math.floor(
            (t.finishesAt - new Date().getTime()) / 60000
          )} min(s)`;
      const tourneyName = t.secondsToStart ? `${t.fullName}` : `${t.fullName}`;
      console.log(
        `joining ${tourneyName} , ${t.clock.limit / 60} + ${
          t.clock.increment
        } , ${t.minutes} min(s) , ${startingIn} , ${t.nbPlayers} player(s)`
      );

      const resp = await api(`tournament/${t.id}/join`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("LICHESS_TOKEN")}`,
        },
        body: "",
      });

      if (resp.ok) {
        console.log("done");
      } else {
        console.error("failed");
      }
    }
  }

  const data = {
    message: "",
    tourneys: [],
    variant,
    variants: [
      { display: "Standard", key: "standard" },
      { display: "Atomic", key: "atomic" },
      { display: "Antichess", key: "antichess" },
      { display: "Crazyhose", key: "crazyhouse" },
      { display: "Horde", key: "horde" },
      { display: "King of the Hill", key: "kingOfTheHill" },
      { display: "Racing Kings", key: "racingKings" },
      { display: "Three Check", key: "threeCheck" },
    ],
  };

  async function refresh() {
    const tourneys = await getTourneys();
    const created = tourneys.created.filter((t) => t.variant.key === variant);
    const started = tourneys.started.filter((t) => t.variant.key === variant);

    let effTourneys = started.concat(created);

    data.message = JSON.stringify(effTourneys, null, 2);

    data.tourneys = effTourneys;
  }

  var app = new Vue({
    el: "#app",
    data,
  });

  document.title = `${variant} Tourneys`;

  refresh();
  signUp(variant);

  setInterval(() => {
    refresh();
  }, 6000);

  setInterval(() => {
    signUp(variant);
  }, 60000);
</script>
